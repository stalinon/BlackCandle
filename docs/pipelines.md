| № | Название пайплайна                    | ID                    | Назначение |
|---|----------------------------------------|------------------------|------------|
| 1 | Анализ портфеля                        | `PortfolioAnalysis`    | Основной анализ по расписанию или вручную |
| 2 | Автоматическое исполнение сделок       | `AutoTradeExecution`   | Совершение сделок на основе сигналов |
| 3 | Восстановление после сбоя              | `FailureRecovery`      | Повтор анализа или сделок после исключения |
---

## Пайплайн `PortfolioAnalysis` — Анализ портфеля

| **Этап** | **Название**                     | **Описание**                                                                                         |
|----------|----------------------------------|------------------------------------------------------------------------------------------------------|
| 1        | Загрузка портфеля                | `PortfolioService.GetCurrentPortfolio()` — получает текущие активы                                  |
| 2        | Получение рыночных данных        | `MarketDataAggregator.FetchHistoricalData()` + `SmartLabClient` для фундаменталки                  |
| 3        | Расчет тех. индикаторов          | `IndicatorService.CalculateIndicators()` — Skender в дело                                           |
| 4        | Фундаментальный скоринг          | `FundamentalScoringService.Score()` — фильтрация по P/E, дивидендам и т.д.                         |
| 5        | Генерация сигналов               | `SignalService.GenerateSignals()` — Buy / Sell / Hold                                              |
| 6        | Сохранение результата            | `AnalysisResultRepository.Save()` — записываем `PortfolioAnalysisResult` и `TradeSignal`          |
| 7        | Логирование                      | `LoggerService.LogStep()` — логи для ада и отката                                                  |

---

## Пайплайн `AutoTradeExecution` — Автоматическое исполнение сделок

| **Этап** | **Название**                         | **Описание**                                                                                         |
|----------|--------------------------------------|------------------------------------------------------------------------------------------------------|
| 1        | Проверка разрешения                  | `BotSettings.EnableAutoTrading` — включён ли режим автотрейдинга                                   |
| 2        | Получение сигналов                   | Берём `TradeSignal` из анализа                                                                     |
| 3        | Проверка лимитов                     | `PortfolioService.ValidateLimits()` — доля тикера, мин. сумма сделки                               |
| 4        | Расчет объема                        | `TradeExecutionService.CalculateVolume()` — сколько покупать/продавать                             |
| 5        | Отправка ордера                      | `BrokerTradeClient.PlaceMarketOrder()` — реальная или фейковая торговля                           |
| 6        | Обновление портфеля                  | `PortfolioService.Update()` — в хранилище                                                           |
| 7        | Лог сделки                           | `LoggerService.LogStep("TradeExecuted")` + `ExecutedTrade`                                          |

---

## Пайплайн `FailureRecovery` — Восстановление после сбоя

| **Этап** | **Название**                     | **Описание**                                                                                         |
|----------|----------------------------------|------------------------------------------------------------------------------------------------------|
| 1        | Обнаружение ошибки               | Отслеживается по логам или failed job status                                                        |
| 2        | Повтор последнего анализа        | `RunPortfolioAnalysisUseCase` повторяется вручную                                                   |
| 3        | Повтор автотрейда (опционально)  | `TradeExecutionService.RetryFailed()` — если есть проваленные сделки                               |
| 4        | Уведомление пользователя         | "Произошёл сбой. Повтор выполнен."                                                                  |
| 5        | Лог восстановления               | `LoggerService.LogStep("RecoveryComplete")`                                                         |
